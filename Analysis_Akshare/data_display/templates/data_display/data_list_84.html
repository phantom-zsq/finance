<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>期权品种打分系统_离线_84分位</title>
    <style>
        body {
            font-family: "Microsoft Yahei", Arial, sans-serif;
            max-width: 100%;
            margin: 0 auto;
            padding: 10px;
            box-sizing: border-box;
            overflow-x: hidden;
        }
        .container {
            text-align: center;
            padding: 0 5px;
        }
        .refresh-info {
            color: #666;
            margin-bottom: 15px;
            font-size: 14px;
        }
        .table-wrapper {
            overflow-x: auto;
            margin-top: 10px;
            border-radius: 4px;
            box-shadow: 0 0 3px rgba(0,0,0,0.1);
        }
        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 1200px;
        }
        th {
            background-color: #f5f5f5;
            position: sticky;
            top: 0;
            z-index: 10;
            padding: 10px 4px;
            border: 1px solid #ddd;
            text-align: center;
            font-size: 12px;
            font-weight: normal;
            white-space: nowrap;
            cursor: pointer;
            user-select: none;
        }
        th:hover {
            background-color: #e9e9e9;
        }
        /* ========== 完全删除三角图标相关样式 ========== */
        /* 移除了th::after、sort-asc::after、sort-desc::after所有样式 */

        /* ========== 原始紧凑列宽（和你最初代码完全一致） ========== */
        th:nth-child(1) { width: 50px; }    /* 序号 */
        th:nth-child(2) { width: 80px; }    /* 交易所 */
        th:nth-child(3) { width: 90px; }    /* 品种名称 */
        th:nth-child(4) { width: 120px; }   /* 合约名称（内容较长） */
        th:nth-child(5) { width: 70px; }    /* 当前价 */
        th:nth-child(6) { width: 70px; }    /* 行权价 */
        th:nth-child(7) { width: 70px; }    /* 限仓 */
        th:nth-child(8) { width: 70px; }    /* 金额 */
        th:nth-child(9) { width: 80px; }    /* 涨跌停比例 */
        th:nth-child(10) { width: 70px; }   /* 八八分位 */
        th:nth-child(11) { width: 70px; }   /* 八四分位 */
        th:nth-child(12) { width: 70px; }   /* 八三分位 */
        th:nth-child(13) { width: 70px; }   /* 八二分位 */
        th:nth-child(14) { width: 70px; }   /* 剩余天数 */
        th:nth-child(15) { width: 70px; }   /* 深度分值 */
        th:nth-child(16) { width: 70px; }   /* 权利金 */
        th:nth-child(17) { width: 70px; }   /* 手续费 */
        th:nth-child(18) { width: 70px; }   /* 平今 */
        th:nth-child(19) { width: 70px; }   /* 保证金率 */
        th:nth-child(20) { width: 80px; }   /* 性价比分值 */
        th:nth-child(21) { width: 60px; }   /* 多空 */
        th:nth-child(22) { width: 70px; }   /* 技术分值 */
        th:nth-child(23) { width: 70px; }   /* 现货价 */
        th:nth-child(24) { width: 70px; }   /* 期货价 */
        th:nth-child(25) { width: 70px; }   /* 基差分值 */
        th:nth-child(26) { width: 70px; }   /* 总分 */

        td {
            padding: 8px 4px;
            border: 1px solid #ddd;
            text-align: center;
            font-size: 12px;
            white-space: nowrap;
        }
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        .loading {
            color: #007bff;
            display: none;
            padding: 15px;
            font-weight: bold;
            animation: blink 1s infinite alternate;
        }
        @keyframes blink {
            from { opacity: 0.7; }
            to { opacity: 1; }
        }
        .error-tip {
            color: #dc3545;
            text-align: center;
            padding: 10px;
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>期权品种打分系统_离线数据_84分位</h1>
        <div class="refresh-info">
            数据将每600秒自动刷新一次 | 上次刷新: <span id="last-refresh"></span>
        </div>
        <div class="loading" id="loading">正在刷新数据...</div>
        <div class="error-tip" id="error-tip">数据刷新失败，请稍后重试！</div>

        <div class="table-wrapper">
            <table id="data-table">
                <thead>
                    <tr>
                        <th data-sort-key="serial">序号</th>
                        <th data-sort-key="交易所">交易所</th>
                        <th data-sort-key="品种名称">品种名称</th>
                        <th data-sort-key="合约名称">合约名称</th>
                        <th data-sort-key="当前价">当前价</th>
                        <th data-sort-key="行权价">行权价</th>
                        <th data-sort-key="限仓">限仓</th>
                        <th data-sort-key="限仓金额">金额</th>
                        <th data-sort-key="涨跌停比例">涨跌停比例</th>
                        <th data-sort-key="八八分位">八八分位</th>
                        <th data-sort-key="八四分位">八四分位</th>
                        <th data-sort-key="八三分位">八三分位</th>
                        <th data-sort-key="八二分位">八二分位</th>
                        <th data-sort-key="剩余天数">剩余天数</th>
                        <th data-sort-key="深度分值">深度分值</th>
                        <th data-sort-key="权利金">权利金</th>
                        <th data-sort-key="手续费">手续费</th>
                        <th data-sort-key="平今">平今</th>
                        <th data-sort-key="保证金率">保证金率</th>
                        <th data-sort-key="性价比分值">性价比分值</th>
                        <th data-sort-key="多空">多空</th>
                        <th data-sort-key="技术分值">技术分值</th>
                        <th data-sort-key="现货价">现货价</th>
                        <th data-sort-key="期货价">期货价</th>
                        <th data-sort-key="基差分值">基差分值</th>
                        <th data-sort-key="总分">总分</th>
                    </tr>
                </thead>
                <tbody id="data-container">
                    {% for record in records %}
                    <tr>
                        <td class="serial-number"></td>
                        <td data-value="{{ record.交易所 }}">{{ record.交易所 }}</td>
                        <td data-value="{{ record.品种名称 }}">{{ record.品种名称 }}</td>
                        <td data-value="{{ record.合约名称 }}">{{ record.合约名称 }}</td>
                        <td data-value="{{ record.当前价 }}">{{ record.当前价 }}</td>
                        <td data-value="{{ record.行权价 }}">{{ record.行权价 }}</td>
                        <td data-value="{{ record.限仓 }}">{{ record.限仓 }}</td>
                        <td data-value="{{ record.限仓金额 }}">{{ record.限仓金额 }}w</td>
                        <td data-value="{{ record.涨跌停比例 }}">{{ record.涨跌停比例 }}</td>
                        <td data-value="{{ record.八八分位 }}">{{ record.八八分位 }}</td>
                        <td data-value="{{ record.八四分位 }}">{{ record.八四分位 }}</td>
                        <td data-value="{{ record.八三分位 }}">{{ record.八三分位 }}</td>
                        <td data-value="{{ record.八二分位 }}">{{ record.八二分位 }}</td>
                        <td data-value="{{ record.剩余天数 }}">{{ record.剩余天数 }}</td>
                        <td data-value="{{ record.深度分值 }}">{{ record.深度分值 }}</td>
                        <td data-value="{{ record.权利金 }}">{{ record.权利金 }}</td>
                        <td data-value="{{ record.手续费 }}">{{ record.手续费 }}</td>
                        <td data-value="{{ record.平今 }}">{{ record.平今 }}</td>
                        <td data-value="{{ record.保证金率 }}">{{ record.保证金率 }}</td>
                        <td data-value="{{ record.性价比分值 }}">{{ record.性价比分值 }}</td>
                        <td data-value="{{ record.多空 }}">{{ record.多空 }}</td>
                        <td data-value="{{ record.技术分值 }}">{{ record.技术分值 }}</td>
                        <td data-value="{{ record.现货价 }}">{{ record.现货价 }}</td>
                        <td data-value="{{ record.期货价 }}">{{ record.期货价 }}</td>
                        <td data-value="{{ record.基差分值 }}">{{ record.基差分值 }}</td>
                        <td data-value="{{ record.总分 }}">{{ record.总分 }}</td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="26" style="text-align: center;">暂无数据，请检查数据库</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <script>
        const CONFIG = {
            refreshInterval: 600000,
            elements: {
                loading: document.getElementById('loading'),
                dataContainer: document.getElementById('data-container'),
                lastRefresh: document.getElementById('last-refresh'),
                errorTip: document.getElementById('error-tip'),
                dataTable: document.getElementById('data-table')
            },
            sortState: {
                currentKey: null,
                isAsc: true
            }
        };

        // 填充序号
        function fillSerialNumber() {
            if (!CONFIG.elements.dataContainer) return;
            const serialCells = document.querySelectorAll('.serial-number');
            serialCells.forEach((cell, index) => {
                cell.textContent = index + 1;
            });
        }

        // 排序核心函数（保留功能，仅去掉箭头样式）
        function sortTable(sortKey, isAsc) {
            const tbody = CONFIG.elements.dataContainer;
            const rows = Array.from(tbody.querySelectorAll('tr'));
            const validRows = rows.filter(row => row.cells.length !== 1);
            if (validRows.length === 0) return;

            const thElements = CONFIG.elements.dataTable.querySelectorAll('thead th');
            let colIndex = -1;
            thElements.forEach((th, idx) => {
                if (th.dataset.sortKey === sortKey) {
                    colIndex = idx;
                }
            });
            if (colIndex === -1) return;

            validRows.sort((a, b) => {
                let valA = a.cells[colIndex].dataset.value || a.cells[colIndex].textContent.trim();
                let valB = b.cells[colIndex].dataset.value || b.cells[colIndex].textContent.trim();

                if (!isNaN(parseFloat(valA)) && !isNaN(parseFloat(valB))) {
                    return isAsc ? (parseFloat(valA) - parseFloat(valB)) : (parseFloat(valB) - parseFloat(valA));
                } else {
                    return isAsc ? valA.localeCompare(valB, 'zh-CN') : valB.localeCompare(valA, 'zh-CN');
                }
            });

            tbody.innerHTML = '';
            validRows.forEach(row => tbody.appendChild(row));
            fillSerialNumber();

            // 移除表头样式更新（因为不需要箭头了）
            CONFIG.sortState.currentKey = sortKey;
            CONFIG.sortState.isAsc = isAsc;
        }

        // 刷新数据
        function refreshData() {
            CONFIG.elements.errorTip.style.display = 'none';
            CONFIG.elements.loading.style.display = 'block';

            fetch(window.location.href, { cache: 'no-cache' })
            .then(response => {
                if (!response.ok) throw new Error(`HTTP错误：${response.status}`);
                return response.text();
            })
            .then(html => {
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                const newData = doc.getElementById('data-container')?.innerHTML || '';
                if (newData) {
                    CONFIG.elements.dataContainer.innerHTML = newData;
                    CONFIG.elements.lastRefresh.textContent = new Date().toLocaleString();
                    if (CONFIG.sortState.currentKey) {
                        sortTable(CONFIG.sortState.currentKey, CONFIG.sortState.isAsc);
                    }
                }
            })
            .catch(error => {
                console.error('刷新数据失败:', error);
                CONFIG.elements.errorTip.style.display = 'block';
                CONFIG.elements.errorTip.textContent = `数据刷新失败：${error.message}，请稍后重试！`;
            })
            .finally(() => {
                CONFIG.elements.loading.style.display = 'none';
                fillSerialNumber();
            });
        }

        // 初始化
        function init() {
            if (CONFIG.elements.lastRefresh) {
                CONFIG.elements.lastRefresh.textContent = new Date().toLocaleString();
            }
            fillSerialNumber();

            // 绑定表头点击事件（排序功能保留）
            CONFIG.elements.dataTable.querySelectorAll('th').forEach(th => {
                const sortKey = th.dataset.sortKey;
                if (sortKey) {
                    th.addEventListener('click', () => {
                        const isAsc = CONFIG.sortState.currentKey === sortKey ? !CONFIG.sortState.isAsc : true;
                        sortTable(sortKey, isAsc);
                    });
                }
            });

            // setInterval(refreshData, CONFIG.refreshInterval);
        }

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>